---
description: Yawn detection business logic and external API integration
---

# DetecÃ§Ã£o de Bocejo - LÃ³gica de NegÃ³cio

## ğŸ¯ Regras de NegÃ³cio Core
- **FrequÃªncia**: analisar a cada 10 frames capturados
- **ValidaÃ§Ã£o**: 3+ frames consecutivos para confirmar bocejo
- **Timeout**: mÃ¡ximo 30s entre anÃ¡lises para conservar bateria
- **Threshold**: razÃ£o boca > 0.6 + confianÃ§a MediaPipe > 0.7

## ğŸ”„ Fluxo de DetecÃ§Ã£o
```typescript
interface YawnDetectionFlow {
  captureFrame: () => Promise<FrameData>;
  extractKeypoints: (frame: FrameData) => Promise<FaceLandmarks>;
  analyzeYawn: (keypoints: FaceLandmarks) => Promise<YawnAnalysis>;
  saveEvent: (analysis: YawnAnalysis) => Promise<void>;
}
```

## ğŸŒ API Externa - AnÃ¡lise de Keypoints
- **Endpoint**: `POST /api/analyze-yawn`
- **Rate Limit**: mÃ¡ximo 6 req/min (1 a cada 10s)
- **Timeout**: 5s mÃ¡ximo por request
- **Retry**: 3 tentativas com exponential backoff

```typescript
interface YawnAnalysisRequest {
  keypoints: FaceLandmarks;
  deviceId: string;
  timestamp: number;
}

interface YawnAnalysisResponse {
  isYawning: boolean;
  confidence: number;
  mouthRatio: number;
  processingTime: number;
}
```

## ğŸ“Š Session Management
- **DuraÃ§Ã£o**: rastrear tempo total da sessÃ£o
- **Eventos**: contar total de bocejos detectados
- **EstatÃ­sticas**: calcular frequÃªncia (bocejos/hora)
- **RelatÃ³rio**: gerar ao final da sessÃ£o

```typescript
interface YawnSession {
  id: string;
  userId: string;
  startTime: Date;
  endTime?: Date;
  totalYawns: number;
  avgFrequency: number;
  events: YawnEvent[];
}
```

## ğŸš¨ Tratamento de Falhas
- **API Offline**: salvar localmente + sync posterior
- **Falha MediaPipe**: reiniciar pipeline + notificar usuÃ¡rio
- **Storage cheio**: alertar + limpar eventos antigos
- **Battery baixa**: reduzir frequÃªncia de anÃ¡lise

## ğŸ“± UX/UI Requirements
- **Loading**: indicador durante processamento de frame
- **Status**: mostrar se detecÃ§Ã£o estÃ¡ ativa
- **Counter**: exibir nÃºmero de bocejos da sessÃ£o
- **Feedback**: vibraÃ§Ã£o sutil quando bocejo detectado

## ğŸ”§ ConfiguraÃ§Ãµes AjustÃ¡veis
```typescript
interface DetectionSettings {
  sensitivity: 'low' | 'medium' | 'high'; // afeta threshold
  frequency: number; // frames entre anÃ¡lises (padrÃ£o: 10)
  enableVibration: boolean;
  saveImages: boolean;
  offlineMode: boolean;
}
```